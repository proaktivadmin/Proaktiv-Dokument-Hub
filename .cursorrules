# AGENT SKILL: GOLDEN STACK EXPERT

YOU ARE AN EXPERT FULL-STACK DEVELOPER SPECIALIZING IN:
- Next.js 14 (App Router) + Tailwind CSS + Shadcn/UI
- Python FastAPI + Pydantic + SQLAlchemy
- Azure Container Apps + Blob Storage

## GENERAL RULES
- AUTOMATED TESTING: Always create a test file when creating a new component or endpoint.
- TYPESCRIPT: Use strict types. No 'any'.
- PYTHON: Use strict type hints (mypy). Use Pydantic for all data validation.
- FILE STRUCTURE: Monorepo structure. /frontend and /backend are siblings.

## BACKEND SKILLS (FASTAPI)
1. SERVICE PATTERN: Business logic never lives in routes. Create a class in `app/services/` (e.g., `AzureStorageService`).
2. DEPENDENCY INJECTION: Use `Depends()` for database sessions and services.
3. ERROR HANDLING: Always raise `HTTPException` with clear details. Never crash the server.
4. CONFIG: Load all secrets from `app/config.py` using Pydantic `BaseSettings`. Never use `os.getenv` directly in logic.

## FRONTEND SKILLS (NEXT.JS)
1. SHADCN/UI: Do not invent UI components. Use `npx shadcn-ui@latest add [component]` logic.
2. CLIENT vs SERVER: Default to Server Components. Use "use client" only when hooks (useState, useEffect) are needed.
3. DATA FETCHING: Use a typed API wrapper (e.g., `lib/api.ts`) rather than fetch() calls inside components.
4. TAILWIND: Use standard utility classes. Avoid arbitrary values (e.g., `w-[123px]`).

## MIGRATION CONTEXT
- We are migrating from `_legacy_v1`.
- If you need to understand specific business logic (e.g., how we calculate fees or valid file types), READ the files in `_legacy_v1` first.

## V2 ARCHITECTURE PATTERNS

### Document-First Paradigm
- Preview is the PRIMARY view, code is SECONDARY
- Use ElementInspector for code viewing, not Monaco by default
- All template views should render the document first

### Shelf Layout Pattern
- Use ShelfLibrary for template collections
- Group by: channel (default), phase, receiver, category
- Dim non-matching cards on filter (opacity: 0.3), don't hide

### Flettekode System
- All merge field operations through MergeFieldService
- Patterns: [[field.name]] for merge, vitec-if for conditions
- Auto-discovery extracts from existing templates

### Component Naming
- Viewer components: *Frame.tsx (A4Frame, SMSFrame)
- Library components: *Library.tsx, *Card.tsx
- Inspector: ElementInspector.tsx

### Key Directories
- Agent Prompts: `.cursor/agents/`
- Specs (Agent Output): `.cursor/specs/`
- Plans: `.cursor/plans/`
- Active Context: `.cursor/active_context.md`

## BACKEND PATTERNS (V2.9+)

### Database
- UUID for all primary keys (match existing pattern)
- JSONB for array/object fields (phases, departments, etc.)
- All timestamps with timezone (TIMESTAMPTZ)
- Decimal for margins (4,2 precision)
- PostgreSQL on Railway (migrated from SQLite/Azure)

### Service Layer
- All service methods must be async
- Business logic never in routers, always in services
- Use `Depends()` for DI (db sessions, services)
- Error handling with HTTPException
- Use `flush()` instead of `commit()` (session auto-commits)

### Template Operations
- Content saves trigger TemplateVersion creation
- Content updates re-scan merge fields automatically
- Settings updates do NOT create versions
- Sanitization is optional via `auto_sanitize` flag
- Version restore creates snapshot before restoring

### Existing Tables
- `templates` - Core template storage with Vitec metadata
- `merge_fields` - Flettekode registry
- `code_patterns` - Reusable HTML snippets
- `layout_partials` - Headers/footers/signatures
- `template_versions` - Version history
- `audit_logs` - Action tracking

### API Patterns
- `/api/templates` - Full CRUD with content/settings
- `/api/merge-fields` - Flettekode CRUD + discovery
- `/api/code-patterns` - Pattern library
- `/api/layout-partials` - Header/footer management
- `/api/dashboard` - Stats and inventory
- `/api/storage` - WebDAV file operations
- `/api/auth` - Password + JWT authentication

### Authentication (V2.9)
- Password-based single-user auth
- JWT tokens with 7-day expiry
- Auth middleware on all `/api/*` routes
- Disabled by default (set `APP_PASSWORD_HASH` to enable)