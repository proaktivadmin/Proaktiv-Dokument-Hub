# Phase 08: Client-Side Outlook Signatures with Set-OutlookSignatures

## Overview

Implement automated Outlook signature deployment using the open-source **Set-OutlookSignatures** project. This solution deploys signatures directly to users' Outlook clients, so they see the signature while composing emails.

## Why Set-OutlookSignatures?

| Feature | Transport Rules | Set-MailboxMessageConfiguration | Set-OutlookSignatures |
|---------|----------------|--------------------------------|----------------------|
| Sender sees signature while composing | No | No | **Yes** |
| Works with Outlook desktop | N/A | Partial (OWA only) | **Yes** |
| Works with Outlook mobile | N/A | No | **Yes** (with add-on) |
| Centrally managed templates | Yes | Yes | **Yes** |
| Per-user dynamic data | Limited | Yes | **Yes** |
| Free | Yes | Yes | **Yes** (core features) |
| No WinRM/RPS required | Via EAC only | Cloud Shell only | **Yes** |

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        Entra ID (Azure AD)                       │
│  - User attributes: displayName, jobTitle, mobilePhone, etc.   │
│  - App Registration with Graph API permissions                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Set-OutlookSignatures                         │
│  - Runs on user's Windows machine (logon script or scheduled)  │
│  - Fetches user data from Graph API                            │
│  - Generates signature from HTML/DOCX template                  │
│  - Writes to Outlook signature folder                           │
│  - Sets as default signature                                    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Outlook Client                              │
│  - Signature appears in compose window                          │
│  - User can edit if allowed                                     │
│  - Syncs via roaming signatures (if enabled)                    │
└─────────────────────────────────────────────────────────────────┘
```

## Implementation Steps

### Phase 1: Setup and Configuration (1-2 hours)

#### Step 1.1: Download Set-OutlookSignatures
```powershell
# Download from GitHub releases
# https://github.com/Set-OutlookSignatures/Set-OutlookSignatures/releases
# Extract to: C:\Tools\Set-OutlookSignatures\
```

#### Step 1.2: Create Entra ID App Registration
Run as Global Admin or Application Administrator:
```powershell
powershell.exe -noexit -file "C:\Tools\Set-OutlookSignatures\sample code\Create-EntraApp.ps1" `
    -AppType "Set-OutlookSignatures" `
    -AppName "Proaktiv-SignatureSync"
```

Required Graph API permissions (created automatically):
- `User.Read.All` - Read user profiles
- `Group.Read.All` - Read group memberships (for template assignment)
- `Mail.Read` - Read mailbox info

#### Step 1.3: Note the App Registration Details
After running the script, save:
- **Application (client) ID**: `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- **Tenant ID**: `<your-tenant-id>` (see Railway env vars)

### Phase 2: Create Signature Template (30 minutes)

#### Step 2.1: Create Template Folder Structure
```
C:\Tools\Set-OutlookSignatures\
├── templates\
│   ├── Proaktiv.htm           # HTML signature template
│   ├── Proaktiv.txt           # Plain text fallback
│   └── _Signatures.ini        # Template assignment rules
```

#### Step 2.2: Create HTML Template (`Proaktiv.htm`)
Using Set-OutlookSignatures placeholder syntax:

```html
<table cellpadding="0" cellspacing="0" border="0" width="100%" style="max-width:540px;min-width:360px;">
  <tr>
    <td>
      <table cellpadding="0" cellspacing="0" border="0" width="100%" style="font-family:Arial,Helvetica,sans-serif;font-size:13px;color:#333333;">
        <tr><td colspan="4" style="font-size:12px;padding-bottom:6px;color:#333333;">Med vennlig hilsen</td></tr>
        <tr>
          <td valign="middle" style="padding-right:18px;">
            <img src="https://proaktiv.no/assets/logos/lilje_clean_52.png" width="80" height="80" alt="Profilbilde" style="display:block;border:0;border-radius:50%;background-color:#f5f5f5;padding:10px;">
          </td>
          <td valign="middle" style="padding-right:22px;">
            <div style="font-size:20px;font-weight:bold;margin-bottom:4px;color:#333333;">$CurrentUserGivenName$ $CurrentUserSurname$</div>
            <div style="color:#bcab8a;font-size:12px;margin-bottom:10px;"><b>$CurrentUserTitle$</b></div>
            <div style="font-size:11px;margin-bottom:4px;">
              <a href="tel:$CurrentUserMobile$" style="color:#333333;text-decoration:none;">
                <img src="https://proaktiv.no/assets/logos/phone.png" width="14" height="14" style="vertical-align:middle;border:0;margin-right:6px;">$CurrentUserMobile$
              </a>
            </div>
            <div style="font-size:11px;">
              <a href="mailto:$CurrentUserMail$" style="color:#333333;text-decoration:none;">
                <img src="https://proaktiv.no/assets/logos/email.png" width="14" height="14" style="vertical-align:middle;border:0;margin-right:6px;">$CurrentUserMail$
              </a>
            </div>
          </td>
          <td valign="middle" style="padding:0 18px;">
            <table cellpadding="0" cellspacing="0" border="0">
              <tr><td style="width:1px;height:95px;background-color:#bcab8a;font-size:1px;line-height:1px;">&nbsp;</td></tr>
            </table>
          </td>
          <td valign="middle" align="center" style="padding-left:18px;">
            <table cellpadding="0" cellspacing="0" border="0" width="155" style="width:155px;">
              <tr>
                <td align="center" style="padding:8px;padding-bottom:16px;background-color:#ffffff;border-radius:4px;">
                  <img src="https://proaktiv.no/assets/logos/Proaktiv_sort.png" width="155" height="auto" style="display:block;border:0;max-width:100%;">
                </td>
              </tr>
              <tr>
                <td align="center" style="padding-top:8px;">
                  <table cellpadding="0" cellspacing="0" border="0" align="center">
                    <tr>
                      <td><a href="https://proaktiv.no/" target="_blank"><img src="https://proaktiv.no/assets/logos/lilje_clean_52.png" width="26" height="26" style="display:block;border:0;"></a></td>
                      <td style="width:17px;"></td>
                      <td><a href="https://www.instagram.com/proaktiveiendomsmegling/" target="_blank"><img src="https://proaktiv.no/assets/logos/instagram.png" width="26" height="26" style="display:block;border:0;"></a></td>
                      <td style="width:17px;"></td>
                      <td><a href="https://www.linkedin.com/company/proaktiv-eiendomsmegling/" target="_blank"><img src="https://proaktiv.no/assets/logos/linkedin.png" width="26" height="26" style="display:block;border:0;"></a></td>
                      <td style="width:17px;"></td>
                      <td><a href="https://www.facebook.com/proaktiveiendom" target="_blank"><img src="https://proaktiv.no/assets/logos/facebook.png" width="26" height="26" style="display:block;border:0;"></a></td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </td>
        </tr>
        <tr>
          <td colspan="4" style="padding-top:12px;font-size:11px;color:#333333;">
            $CurrentUserDepartment$ – Org. nr. 912 404 447 | $CurrentUserStreetAddress$, $CurrentUserPostalCode$ $CurrentUserCity$
          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
```

#### Step 2.3: Create Plain Text Template (`Proaktiv.txt`)
```
Med vennlig hilsen

$CurrentUserGivenName$ $CurrentUserSurname$
$CurrentUserTitle$

Mobil: $CurrentUserMobile$
E-post: $CurrentUserMail$

$CurrentUserDepartment$
$CurrentUserStreetAddress$, $CurrentUserPostalCode$ $CurrentUserCity$
Org. nr. 912 404 447

proaktiv.no
```

#### Step 2.4: Create Template Assignment (`_Signatures.ini`)
```ini
[Proaktiv]
; Apply to all users
defaultNew = true
defaultReplyFwd = true
```

### Phase 3: Test on Your Machine (30 minutes)

#### Step 3.1: Run in Simulation Mode First
```powershell
cd C:\Tools\Set-OutlookSignatures

.\Set-OutlookSignatures.ps1 `
    -GraphOnly true `
    -GraphClientId "YOUR_CLIENT_ID_HERE" `
    -SignatureTemplatePath ".\templates" `
    -SignatureIniFile ".\templates\_Signatures.ini" `
    -UseHtmTemplates true `
    -SimulateUser "froyland@proaktiv.no" `
    -SimulateMailboxes "froyland@proaktiv.no"
```

This creates signatures in `Documents\Outlook Signatures\` without modifying Outlook.

#### Step 3.2: Verify Simulation Output
Check the generated files:
- `Documents\Outlook Signatures\Proaktiv.htm`
- `Documents\Outlook Signatures\Proaktiv.txt`

#### Step 3.3: Run Live (Modifies Outlook)
```powershell
.\Set-OutlookSignatures.ps1 `
    -GraphOnly true `
    -GraphClientId "YOUR_CLIENT_ID_HERE" `
    -SignatureTemplatePath ".\templates" `
    -SignatureIniFile ".\templates\_Signatures.ini" `
    -UseHtmTemplates true
```

#### Step 3.4: Open Outlook and Compose New Email
Verify the signature appears automatically.

### Phase 4: Deploy to All Employees (1-2 hours)

#### Option A: Intune (Recommended for Cloud-Managed Devices)

1. **Package the script** as a Win32 app or PowerShell script
2. **Create Intune script deployment**:
   - Target: All Proaktiv users or specific groups
   - Run context: User context
   - Run at: Logon or scheduled

#### Option B: Group Policy Logon Script

1. **Copy files to network share**: `\\proaktiv.no\netlogon\signatures\`
2. **Create GPO** with logon script:
   ```
   powershell.exe -ExecutionPolicy Bypass -File "\\proaktiv.no\netlogon\signatures\Set-OutlookSignatures.ps1" -GraphOnly true -GraphClientId "YOUR_CLIENT_ID"
   ```

#### Option C: Scheduled Task

Deploy via Intune or GPO:
```powershell
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument '-ExecutionPolicy Bypass -File "C:\Tools\Set-OutlookSignatures\Set-OutlookSignatures.ps1" -GraphOnly true -GraphClientId "YOUR_CLIENT_ID"'
$trigger = New-ScheduledTaskTrigger -AtLogOn
$principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount
Register-ScheduledTask -TaskName "ProaktivSignatureSync" -Action $action -Trigger $trigger -Principal $principal
```

## Placeholder Reference

Set-OutlookSignatures uses `$VariableName$` syntax. Key variables:

| Placeholder | Entra ID Attribute | Example |
|------------|-------------------|---------|
| `$CurrentUserGivenName$` | givenName | Adrian |
| `$CurrentUserSurname$` | surname | Frøyland |
| `$CurrentUserTitle$` | jobTitle | Daglig leder |
| `$CurrentUserMobile$` | mobilePhone | +47 900 00 000 |
| `$CurrentUserMail$` | mail | froyland@proaktiv.no |
| `$CurrentUserDepartment$` | department | Stavanger |
| `$CurrentUserStreetAddress$` | streetAddress | Lagårdsveien 78 |
| `$CurrentUserPostalCode$` | postalCode | 4010 |
| `$CurrentUserCity$` | city | Stavanger |

## Prerequisites Checklist

- [ ] Windows machines with Outlook desktop installed
- [ ] Entra ID app registration created
- [ ] Graph API permissions granted (admin consent)
- [ ] User attributes populated in Entra ID (via Vitec sync)
- [ ] Network access to proaktiv.no for logo images
- [ ] PowerShell execution policy allows scripts

## Rollout Plan

| Phase | Scope | Timeline |
|-------|-------|----------|
| 1. Setup | Download, app registration, template | Day 1 |
| 2. Test | Your account only | Day 1 |
| 3. Pilot | 3-5 employees from different offices | Day 2-3 |
| 4. Rollout | All employees | Day 4-5 |
| 5. Monitor | Check for issues, gather feedback | Week 2 |

## Success Criteria

- [ ] Signature appears in Outlook compose window
- [ ] All placeholders resolve correctly (name, title, phone, etc.)
- [ ] Logo and social icons display properly
- [ ] Signature set as default for new emails and replies
- [ ] Works on Outlook desktop (Windows)
- [ ] No user action required after deployment

## Limitations (Free Version)

- Windows only (macOS/mobile requires Benefactor Circle add-on)
- Classic Outlook only (New Outlook requires add-on)
- No central management UI (template files only)

## Cost

- **Free version**: Sufficient for Windows + Classic Outlook
- **Benefactor Circle add-on**: ~€3.50/mailbox one-time for full cross-platform support

## References

- [Set-OutlookSignatures GitHub](https://github.com/Set-OutlookSignatures/Set-OutlookSignatures)
- [Quick Start Guide](https://set-outlooksignatures.com/quickstart)
- [Full Documentation](https://set-outlooksignatures.com/help)
- [Placeholder Variables](https://set-outlooksignatures.com/details#6-replacement-variables)
