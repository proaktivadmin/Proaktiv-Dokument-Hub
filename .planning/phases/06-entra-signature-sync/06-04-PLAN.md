---
phase: 06-entra-signature-sync
plan: 04
type: execute
wave: 3
depends_on: [06-02, 06-03]
files_modified: []
autonomous: false
---

<objective>
Test and validate the sync script with dry-run, single user, and full sync scenarios.
</objective>

<tasks>
<task type="manual">
  <name>Task 1: Prerequisites Check</name>
  <files>-</files>
  <action>
    Verify before testing:
    - [ ] Azure App Registration exists
    - [ ] API permissions granted with admin consent
    - [ ] Certificate or client secret configured
    - [ ] Exchange role assigned
    - [ ] PowerShell modules installed (Microsoft.Graph, ExchangeOnlineManagement)
    - [ ] Local database has employee data
    - [ ] At least one test user email matches Entra ID
  </action>
</task>

<task type="manual">
  <name>Task 2: Test Database Connectivity</name>
  <files>-</files>
  <action>
    Run script with database query only:
    ```powershell
    .\backend\scripts\Sync-EntraIdEmployees.ps1 -SourceDb local -DryRun -SyncScope none
    ```
    
    Expected: List of employees retrieved from database.
  </action>
</task>

<task type="manual">
  <name>Task 3: Test Single User Dry Run</name>
  <files>-</files>
  <action>
    Run with single test user:
    ```powershell
    .\backend\scripts\Sync-EntraIdEmployees.ps1 `
        -SourceDb local `
        -TenantId "your-tenant-id" `
        -ClientId "your-client-id" `
        -CertThumbprint "your-thumbprint" `
        -FilterEmail "test.user@proaktiv.no" `
        -SyncScope profile `
        -DryRun
    ```
    
    Expected: Shows what would be updated, no actual changes.
  </action>
</task>

<task type="manual">
  <name>Task 4: Test Single User Profile Sync</name>
  <files>-</files>
  <action>
    Run actual profile sync for single user:
    ```powershell
    .\backend\scripts\Sync-EntraIdEmployees.ps1 `
        -SourceDb local `
        -TenantId "your-tenant-id" `
        -ClientId "your-client-id" `
        -CertThumbprint "your-thumbprint" `
        -FilterEmail "test.user@proaktiv.no" `
        -SyncScope profile
    ```
    
    Verify in Azure Portal:
    - User's profile properties updated
    - Job title, phone, department match database
  </action>
</task>

<task type="manual">
  <name>Task 5: Test Photo Upload</name>
  <files>-</files>
  <action>
    Run photo sync for single user:
    ```powershell
    .\backend\scripts\Sync-EntraIdEmployees.ps1 `
        -SourceDb local `
        -TenantId "your-tenant-id" `
        -ClientId "your-client-id" `
        -CertThumbprint "your-thumbprint" `
        -FilterEmail "test.user@proaktiv.no" `
        -SyncScope photo
    ```
    
    Verify:
    - Photo appears in Azure Portal user profile
    - Photo appears in Outlook/Teams
  </action>
</task>

<task type="manual">
  <name>Task 6: Test Signature Push</name>
  <files>-</files>
  <action>
    Run signature sync for single user:
    ```powershell
    .\backend\scripts\Sync-EntraIdEmployees.ps1 `
        -SourceDb local `
        -TenantId "your-tenant-id" `
        -ClientId "your-client-id" `
        -CertThumbprint "your-thumbprint" `
        -FilterEmail "test.user@proaktiv.no" `
        -SyncScope signature
    ```
    
    Verify:
    - Log in as test user to Outlook Web
    - Compose new email
    - Signature appears automatically
  </action>
</task>

<task type="manual">
  <name>Task 7: Test Full Sync (Small Batch)</name>
  <files>-</files>
  <action>
    Run full sync for a few users (one office):
    ```powershell
    .\backend\scripts\Sync-EntraIdEmployees.ps1 `
        -SourceDb local `
        -TenantId "your-tenant-id" `
        -ClientId "your-client-id" `
        -CertThumbprint "your-thumbprint" `
        -FilterEmail "user1@proaktiv.no","user2@proaktiv.no","user3@proaktiv.no" `
        -SyncScope all
    ```
    
    Verify:
    - All three users updated
    - No errors in log
    - Rate limiting works (delays between calls)
  </action>
</task>

<task type="manual">
  <name>Task 8: Production Dry Run</name>
  <files>-</files>
  <action>
    Run against Railway database with dry-run:
    ```powershell
    $env:RAILWAY_DATABASE_URL = "your-railway-url"
    
    .\backend\scripts\Sync-EntraIdEmployees.ps1 `
        -SourceDb railway `
        -TenantId "your-tenant-id" `
        -ClientId "your-client-id" `
        -CertThumbprint "your-thumbprint" `
        -SyncScope all `
        -DryRun
    ```
    
    Review output carefully before production run.
  </action>
</task>
</tasks>

<success_criteria>
- All test scenarios pass
- No unexpected errors
- Rate limiting prevents throttling
- Dry-run accurately predicts changes
- Single user test verified in Azure Portal
- Signature appears in Outlook Web
- Ready for production use
</success_criteria>
