---
phase: 06-entra-signature-sync
plan: 05
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - backend/app/routers/entra_sync.py
  - backend/app/schemas/entra_sync.py
  - backend/app/services/entra_sync_service.py
  - backend/app/main.py
autonomous: true
---

<objective>
Create backend API endpoints for Entra ID sync operations (preview, single push, batch push).
</objective>

<tasks>
<task type="auto">
  <name>Task 1: Create Entra Sync Schemas</name>
  <files>backend/app/schemas/entra_sync.py</files>
  <action>
    Create Pydantic schemas:
    - EntraSyncPreview: Shows what would change for an employee
    - EntraSyncResult: Result of a sync operation
    - SignaturePreview: HTML signature preview
    - EntraSyncBatchRequest: Batch sync request with employee IDs
    - EntraSyncBatchResult: Batch sync result with success/failure counts
  </action>
</task>

<task type="auto">
  <name>Task 2: Create Entra Sync Service</name>
  <files>backend/app/services/entra_sync_service.py</files>
  <action>
    Create service class with methods:
    - get_sync_preview(employee_id): Compare DB data with Entra ID
    - generate_signature_preview(employee_id): Generate HTML signature
    - sync_employee_profile(employee_id): Push profile to Entra ID
    - sync_employee_photo(employee_id): Push photo to Entra ID
    - sync_employee_signature(employee_id): Push signature to Exchange
    - sync_batch(employee_ids, scope): Batch sync operation
    
    Note: This will call the PowerShell script via subprocess or
    implement directly using Microsoft Graph Python SDK.
  </action>
</task>

<task type="auto">
  <name>Task 3: Create Entra Sync Router</name>
  <files>backend/app/routers/entra_sync.py</files>
  <action>
    Create FastAPI router with endpoints:
    - GET /api/entra-sync/preview/{employee_id}: Get sync preview
    - GET /api/entra-sync/signature-preview/{employee_id}: Preview signature
    - POST /api/entra-sync/push/{employee_id}: Push single employee
    - POST /api/entra-sync/push-batch: Push multiple employees
    - GET /api/entra-sync/status: Check Entra ID connection status
    - GET /api/entra-sync/roaming-signatures: Check roaming signatures status
  </action>
</task>

<task type="auto">
  <name>Task 4: Register Router in Main</name>
  <files>backend/app/main.py</files>
  <action>
    Add entra_sync router to FastAPI app.
  </action>
</task>

<task type="auto">
  <name>Task 5: Add Configuration</name>
  <files>backend/app/config.py</files>
  <action>
    Add Entra ID configuration settings:
    - ENTRA_TENANT_ID
    - ENTRA_CLIENT_ID
    - ENTRA_CLIENT_SECRET (or ENTRA_CERT_THUMBPRINT)
    - ENTRA_ENABLED (boolean to enable/disable feature)
  </action>
</task>
</tasks>

<success_criteria>
- All endpoints return correct responses
- Preview shows diff between DB and Entra ID
- Signature preview renders correctly
- Single push updates Entra ID
- Batch push handles multiple employees
- Proper error handling for auth failures
</success_criteria>
