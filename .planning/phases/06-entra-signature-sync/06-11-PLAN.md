---
phase: 06-entra-signature-sync
plan: 11
type: execute
wave: 3
depends_on: [06-09]
files_modified:
  - backend/app/schemas/office.py
  - backend/app/services/office_service.py
  - backend/app/routers/offices.py
autonomous: true
---

<objective>
Create backend API for merging duplicate offices.
</objective>

<context>
Merge operation:
1. User selects a "target" office (the one to keep)
2. User selects one or more "source" offices (duplicates to merge)
3. System moves all employees from source offices to target
4. System moves all assets from source offices to target
5. System optionally copies missing data from sources to target
6. System deactivates or deletes source offices
</context>

<tasks>
<task type="auto">
  <name>Task 1: Create Merge Schemas</name>
  <files>backend/app/schemas/office.py</files>
  <action>
    Add merge-related schemas:
    ```python
    class OfficeMergeRequest(BaseModel):
        target_office_id: UUID
        source_office_ids: list[UUID]
        copy_missing_fields: bool = True  # Copy data from sources if target is empty
        delete_sources: bool = False  # Delete sources (vs deactivate)
    
    class OfficeMergePreview(BaseModel):
        target_office: OfficeResponse
        source_offices: list[OfficeResponse]
        employees_to_move: int
        assets_to_move: int
        fields_to_copy: list[str]  # Which fields would be copied
    
    class OfficeMergeResult(BaseModel):
        success: bool
        target_office_id: UUID
        employees_moved: int
        assets_moved: int
        fields_copied: list[str]
        sources_processed: int
        error: str | None = None
    ```
  </action>
</task>

<task type="auto">
  <name>Task 2: Create Merge Service Methods</name>
  <files>backend/app/services/office_service.py</files>
  <action>
    Add merge methods to OfficeService:
    ```python
    async def get_merge_preview(
        self, 
        target_id: UUID, 
        source_ids: list[UUID]
    ) -> OfficeMergePreview:
        """Preview what a merge would do."""
        pass
    
    async def merge_offices(
        self,
        target_id: UUID,
        source_ids: list[UUID],
        copy_missing_fields: bool = True,
        delete_sources: bool = False
    ) -> OfficeMergeResult:
        """
        Merge source offices into target.
        
        1. Move all employees to target
        2. Move all assets to target
        3. Optionally copy missing fields
        4. Deactivate or delete sources
        """
        pass
    ```
  </action>
</task>

<task type="auto">
  <name>Task 3: Implement Merge Logic</name>
  <files>backend/app/services/office_service.py</files>
  <action>
    Implement merge_offices:
    ```python
    async def merge_offices(self, ...):
        async with self.db.begin():
            target = await self.get(target_id)
            if not target:
                raise HTTPException(404, "Target office not found")
            
            employees_moved = 0
            assets_moved = 0
            fields_copied = []
            
            for source_id in source_ids:
                source = await self.get(source_id)
                if not source:
                    continue
                
                # Move employees
                for emp in source.employees:
                    emp.office_id = target_id
                    employees_moved += 1
                
                # Move assets
                for asset in source.assets:
                    asset.office_id = target_id
                    assets_moved += 1
                
                # Copy missing fields
                if copy_missing_fields:
                    for field in ['phone', 'email', 'street_address', ...]:
                        if not getattr(target, field) and getattr(source, field):
                            setattr(target, field, getattr(source, field))
                            fields_copied.append(field)
                
                # Deactivate or delete source
                if delete_sources:
                    await self.db.delete(source)
                else:
                    source.is_active = False
            
            await self.db.commit()
            
            return OfficeMergeResult(...)
    ```
  </action>
</task>

<task type="auto">
  <name>Task 4: Add Merge Endpoints</name>
  <files>backend/app/routers/offices.py</files>
  <action>
    Add merge endpoints:
    ```python
    @router.post("/merge/preview")
    async def preview_merge(
        request: OfficeMergeRequest,
        db: AsyncSession = Depends(get_db)
    ) -> OfficeMergePreview:
        """Preview what a merge would do."""
        service = OfficeService(db)
        return await service.get_merge_preview(
            request.target_office_id,
            request.source_office_ids
        )
    
    @router.post("/merge")
    async def merge_offices(
        request: OfficeMergeRequest,
        db: AsyncSession = Depends(get_db)
    ) -> OfficeMergeResult:
        """Merge source offices into target."""
        service = OfficeService(db)
        return await service.merge_offices(
            request.target_office_id,
            request.source_office_ids,
            request.copy_missing_fields,
            request.delete_sources
        )
    ```
  </action>
</task>
</tasks>

<success_criteria>
- Preview endpoint shows accurate counts
- Merge moves all employees correctly
- Merge moves all assets correctly
- Missing fields copied when enabled
- Sources deactivated/deleted as requested
- Transaction rolls back on error
</success_criteria>
