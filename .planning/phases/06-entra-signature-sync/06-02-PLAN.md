---
phase: 06-entra-signature-sync
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - backend/scripts/Sync-EntraIdEmployees.ps1
  - run-entra-sync.bat
autonomous: true
---

<objective>
Implement the main PowerShell sync script with profile, photo, and signature capabilities.
</objective>

<tasks>
<task type="auto">
  <name>Task 1: Create Main PowerShell Script</name>
  <files>backend/scripts/Sync-EntraIdEmployees.ps1</files>
  <action>
    Create PowerShell script with:
    - CmdletBinding with parameter validation
    - Parameters: SourceDb, SyncScope, TenantId, ClientId, CertThumbprint/ClientSecret
    - Safety parameters: DryRun, Force, FilterEmail
    - Database connectivity (Python bridge or direct)
    - Microsoft Graph authentication
    - Exchange Online authentication
    - Employee iteration with progress display
    - Error handling with retry logic
    - Summary report generation
  </action>
</task>

<task type="auto">
  <name>Task 2: Implement Database Query Function</name>
  <files>backend/scripts/Sync-EntraIdEmployees.ps1</files>
  <action>
    Create function Get-EmployeesFromDatabase:
    - Use Python bridge to query PostgreSQL
    - Return employee objects with office data
    - Handle connection errors gracefully
    - Support local and Railway database
  </action>
</task>

<task type="auto">
  <name>Task 3: Implement Profile Sync Function</name>
  <files>backend/scripts/Sync-EntraIdEmployees.ps1</files>
  <action>
    Create function Sync-UserProfile:
    - Match employee to Entra ID user by email/UPN
    - Compare current values with new values
    - Update only changed properties
    - Log changes made
    - Handle 404 (user not found) gracefully
  </action>
</task>

<task type="auto">
  <name>Task 4: Implement Photo Sync Function</name>
  <files>backend/scripts/Sync-EntraIdEmployees.ps1</files>
  <action>
    Create function Sync-UserPhoto:
    - Download photo from profile_image_url
    - Check if photo needs updating (size/hash comparison)
    - Upload to Microsoft Graph
    - Clean up temp files
    - Handle missing/invalid photo URLs
  </action>
</task>

<task type="auto">
  <name>Task 5: Implement Signature Push Function</name>
  <files>backend/scripts/Sync-EntraIdEmployees.ps1</files>
  <action>
    Create function Push-EmailSignature:
    - Load HTML template from file
    - Replace placeholders with employee data
    - Call Set-MailboxMessageConfiguration
    - Handle roaming signatures warning
    - Support plain text fallback
  </action>
</task>

<task type="auto">
  <name>Task 6: Create Batch Launcher</name>
  <files>run-entra-sync.bat</files>
  <action>
    Create Windows batch file:
    - Display usage help
    - Forward parameters to PowerShell script
    - Handle common scenarios (dry-run, single user)
  </action>
</task>

<task type="auto">
  <name>Task 7: Add Rate Limiting and Progress</name>
  <files>backend/scripts/Sync-EntraIdEmployees.ps1</files>
  <action>
    Add:
    - Delay between API calls (configurable)
    - Progress bar for bulk operations
    - Retry logic with exponential backoff
    - Summary statistics at end
  </action>
</task>
</tasks>

<success_criteria>
- Script runs without errors in -DryRun mode
- Can connect to local PostgreSQL database
- Can authenticate to Microsoft Graph
- Can authenticate to Exchange Online
- Profile updates work for single user
- Photo upload works for single user
- Signature push works for single user
</success_criteria>
