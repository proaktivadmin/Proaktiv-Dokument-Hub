---
phase: 06-entra-signature-sync
plan: 09
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - backend/alembic/versions/YYYYMMDD_add_office_region.py
  - backend/app/models/office.py
  - backend/app/schemas/office.py
  - backend/app/routers/offices.py
  - frontend/src/types/v3.ts
autonomous: true
---

<objective>
Add region field to offices for geographic grouping and filtering.
</objective>

<context>
Regions for Norwegian real estate offices:
- Trøndelag (Trondheim area)
- Romerike (Lillestrøm, Lørenskog area)
- Sør-Rogaland (Stavanger, Sandnes, Sola area)
- Vest (Bergen, Voss area)
- Sør (Kristiansand, Skien area)
- Øst (Oslo, Drammen area)
</context>

<tasks>
<task type="auto">
  <name>Task 1: Create Alembic Migration</name>
  <files>backend/alembic/versions/YYYYMMDD_add_office_region.py</files>
  <action>
    Add region column to offices table:
    ```python
    op.add_column('offices', sa.Column('region', sa.String(50), nullable=True))
    op.create_index('idx_offices_region', 'offices', ['region'])
    ```
  </action>
</task>

<task type="auto">
  <name>Task 2: Update Office Model</name>
  <files>backend/app/models/office.py</files>
  <action>
    Add region field:
    ```python
    # Region for geographic grouping
    region: Mapped[str | None] = mapped_column(String(50), nullable=True)
    ```
    
    Add to __table_args__:
    ```python
    Index("idx_offices_region", "region"),
    ```
  </action>
</task>

<task type="auto">
  <name>Task 3: Update Pydantic Schemas</name>
  <files>backend/app/schemas/office.py</files>
  <action>
    Add region to:
    - OfficeCreate
    - OfficeUpdate
    - OfficeResponse
    
    Add RegionEnum or list of valid regions:
    ```python
    VALID_REGIONS = [
        "Trøndelag",
        "Romerike", 
        "Sør-Rogaland",
        "Vest",
        "Sør",
        "Øst"
    ]
    ```
  </action>
</task>

<task type="auto">
  <name>Task 4: Add Region Filter to List Endpoint</name>
  <files>backend/app/routers/offices.py</files>
  <action>
    Add region query parameter to list endpoint:
    ```python
    @router.get("/")
    async def list_offices(
        region: str | None = None,
        city: str | None = None,
        ...
    ):
    ```
  </action>
</task>

<task type="auto">
  <name>Task 5: Add Regions List Endpoint</name>
  <files>backend/app/routers/offices.py</files>
  <action>
    Add endpoint to get all regions:
    ```python
    @router.get("/regions")
    async def get_regions():
        return {"regions": VALID_REGIONS}
    ```
  </action>
</task>

<task type="auto">
  <name>Task 6: Update Frontend Types</name>
  <files>frontend/src/types/v3.ts</files>
  <action>
    Add region to Office interface:
    ```typescript
    export interface Office {
      // ... existing fields
      region?: string;
    }
    
    export const REGIONS = [
      "Trøndelag",
      "Romerike",
      "Sør-Rogaland",
      "Vest",
      "Sør",
      "Øst"
    ] as const;
    
    export type Region = typeof REGIONS[number];
    ```
  </action>
</task>

<task type="auto">
  <name>Task 7: Run Migration</name>
  <files>-</files>
  <action>
    Run: alembic upgrade head
  </action>
</task>
</tasks>

<success_criteria>
- Region column exists in database
- API accepts region in create/update
- API filters by region in list
- Frontend types updated
- Migration reversible
</success_criteria>
