---
phase: 06-entra-signature-sync
plan: 12
type: execute
wave: 4
depends_on: [06-11]
files_modified:
  - frontend/src/types/office.ts
  - frontend/src/lib/api/offices.ts
  - frontend/src/components/offices/OfficeMergeDialog.tsx
  - frontend/src/components/offices/OfficeGrid.tsx
  - frontend/src/app/offices/page.tsx
autonomous: true
---

<objective>
Create frontend UI for merging duplicate offices.
</objective>

<tasks>
<task type="auto">
  <name>Task 1: Add Merge Types</name>
  <files>frontend/src/types/office.ts</files>
  <action>
    Add merge-related types:
    ```typescript
    export interface OfficeMergeRequest {
      target_office_id: string;
      source_office_ids: string[];
      copy_missing_fields: boolean;
      delete_sources: boolean;
    }
    
    export interface OfficeMergePreview {
      target_office: Office;
      source_offices: Office[];
      employees_to_move: number;
      assets_to_move: number;
      fields_to_copy: string[];
    }
    
    export interface OfficeMergeResult {
      success: boolean;
      target_office_id: string;
      employees_moved: number;
      assets_moved: number;
      fields_copied: string[];
      sources_processed: number;
      error?: string;
    }
    ```
  </action>
</task>

<task type="auto">
  <name>Task 2: Add Merge API Functions</name>
  <files>frontend/src/lib/api/offices.ts</files>
  <action>
    Add merge functions:
    ```typescript
    previewMerge: async (request: OfficeMergeRequest) =>
      api.post<OfficeMergePreview>('/offices/merge/preview', request),
    
    merge: async (request: OfficeMergeRequest) =>
      api.post<OfficeMergeResult>('/offices/merge', request),
    ```
  </action>
</task>

<task type="auto">
  <name>Task 3: Create OfficeMergeDialog</name>
  <files>frontend/src/components/offices/OfficeMergeDialog.tsx</files>
  <action>
    Create merge dialog with:
    
    **Step 1: Select Target**
    - Dropdown/search to select target office
    - Shows office card preview
    
    **Step 2: Select Sources**
    - Multi-select list of other offices
    - Checkbox for each office
    - Can select multiple sources
    - Shows employee/asset counts for each
    
    **Step 3: Preview & Confirm**
    - Shows merge preview:
      - Target office summary
      - List of sources to merge
      - "X employees will be moved"
      - "X assets will be moved"
      - "These fields will be copied: ..."
    - Options:
      - [ ] Copy missing data from sources
      - [ ] Delete sources (instead of deactivate)
    - Confirm button with warning
    
    **Step 4: Result**
    - Success message with counts
    - Or error message
    - Close button
  </action>
</task>

<task type="auto">
  <name>Task 4: Add Selection Mode to OfficeGrid</name>
  <files>frontend/src/components/offices/OfficeGrid.tsx</files>
  <action>
    Add multi-select for merge:
    - New state: selectionMode: boolean
    - New state: selectedIds: Set<string>
    - "Velg for sammenslåing" toggle button
    - Checkboxes on office cards
    - Selection count badge
    
    When 2+ offices selected:
    - Show "Slå sammen X kontorer" button
    - Opens OfficeMergeDialog with selected offices
  </action>
</task>

<task type="auto">
  <name>Task 5: Add Merge to OfficeCard Dropdown</name>
  <files>frontend/src/components/offices/OfficeCard.tsx</files>
  <action>
    Add "Slå sammen med..." menu item:
    - Opens OfficeMergeDialog with this office as target
    - User then selects sources
  </action>
</task>

<task type="auto">
  <name>Task 6: Wire Up in Offices Page</name>
  <files>frontend/src/app/offices/page.tsx</files>
  <action>
    Add dialog state and handlers:
    - State for OfficeMergeDialog
    - Handle merge success with toast
    - Refetch offices after merge
  </action>
</task>
</tasks>

<success_criteria>
- Can select target office
- Can select multiple source offices
- Preview shows accurate counts
- Merge executes successfully
- Sources are deactivated/deleted
- Employees appear under target
- Toast shows success/error
- Grid refreshes after merge
</success_criteria>
