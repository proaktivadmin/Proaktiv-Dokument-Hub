---
phase: 08-sync-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models/notification.py
  - backend/app/models/__init__.py
  - backend/alembic/versions/xxxx_add_notifications_table.py
autonomous: true
---

<objective>
Create the Notification database model and Alembic migration for storing sync notifications.
</objective>

<context>
Read these files first:
- `.planning/phases/08-sync-notifications/HANDOVER.md` - Master context
- `backend/app/models/audit_log.py` - Similar model pattern
- `backend/app/models/base.py` - Base class and custom types
</context>

<tasks>
<task type="auto">
  <name>Task 1: Create Notification Model</name>
  <files>backend/app/models/notification.py</files>
  <action>
    Create SQLAlchemy model with fields:
    
    ```python
    id: UUID (primary key, GUID type)
    type: str (50 chars) - notification type enum
    entity_type: str (50 chars) - 'employee', 'office', 'sync'
    entity_id: UUID | None - reference to related entity
    title: str (255 chars) - notification title
    message: str (text) - detailed message
    severity: str (20 chars) - 'info', 'warning', 'error'
    is_read: bool (default False) - read status
    metadata: dict | None (JSONType) - additional context
    created_at: datetime (timezone-aware, server default)
    ```
    
    Add indexes:
    - `idx_notifications_unread` on `is_read`
    - `idx_notifications_created` on `created_at`
    - `idx_notifications_type` on `type`
    - `idx_notifications_entity` on `entity_type`, `entity_id`
  </action>
</task>

<task type="auto">
  <name>Task 2: Export Model from __init__.py</name>
  <files>backend/app/models/__init__.py</files>
  <action>
    Add import and export for Notification model:
    
    ```python
    from app.models.notification import Notification
    ```
    
    Add to `__all__` list if present.
  </action>
</task>

<task type="auto">
  <name>Task 3: Create Alembic Migration</name>
  <files>backend/alembic/versions/</files>
  <action>
    Generate migration with:
    ```bash
    cd backend
    alembic revision --autogenerate -m "add notifications table"
    ```
    
    Verify the generated migration includes:
    - CREATE TABLE notifications
    - All columns with correct types
    - All indexes
    - Down migration (DROP TABLE)
  </action>
</task>

<task type="auto">
  <name>Task 4: Apply Migration Locally</name>
  <files>-</files>
  <action>
    Apply migration to local database:
    ```bash
    cd backend
    alembic upgrade head
    ```
    
    Verify with:
    ```bash
    alembic current
    ```
  </action>
</task>

<task type="manual">
  <name>Task 5: Apply Migration to Railway</name>
  <files>-</files>
  <action>
    IMPORTANT: Railway migrations must be applied manually.
    
    ```powershell
    $env:DATABASE_URL = "postgresql://postgres:PASSWORD@shuttle.proxy.rlwy.net:51557/railway"
    cd backend
    python -m alembic upgrade head
    python -m alembic current  # Verify shows new version (head)
    ```
    
    If migration fails, create fallback script with:
    ```sql
    CREATE TABLE IF NOT EXISTS notifications (
      id UUID PRIMARY KEY,
      type VARCHAR(50) NOT NULL,
      entity_type VARCHAR(50) NOT NULL,
      entity_id UUID,
      title VARCHAR(255) NOT NULL,
      message TEXT NOT NULL,
      severity VARCHAR(20) NOT NULL DEFAULT 'info',
      is_read BOOLEAN NOT NULL DEFAULT FALSE,
      metadata JSONB,
      created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );
    
    CREATE INDEX IF NOT EXISTS idx_notifications_unread ON notifications(is_read);
    CREATE INDEX IF NOT EXISTS idx_notifications_created ON notifications(created_at);
    CREATE INDEX IF NOT EXISTS idx_notifications_type ON notifications(type);
    CREATE INDEX IF NOT EXISTS idx_notifications_entity ON notifications(entity_type, entity_id);
    ```
  </action>
</task>
</tasks>

<success_criteria>
- Notification model created with all fields and indexes
- Model exported from models/__init__.py
- Alembic migration generated and applied locally
- Migration applied to Railway (or fallback SQL executed)
- `alembic current` shows head on both local and Railway
</success_criteria>
