---
phase: 08-sync-notifications
plan: 06
type: verify
wave: 6
depends_on: [08-04, 08-05]
files_modified: []
autonomous: true
---

<objective>
Verify the complete notification system works end-to-end with testing and QA.
</objective>

<context>
Read these files first:
- `.planning/phases/08-sync-notifications/HANDOVER.md` - Master context
- All previous PLANs to understand what was built
</context>

<tasks>
<task type="auto">
  <name>Task 1: Backend Unit Tests</name>
  <files>backend/tests/test_notification_service.py</files>
  <action>
    Create pytest tests for NotificationService:
    
    ```python
    import pytest
    from uuid import uuid4
    from app.services.notification_service import NotificationService
    from app.schemas.notification import NotificationCreate
    
    @pytest.mark.asyncio
    async def test_create_notification(db_session):
        notification = await NotificationService.create(
            db_session,
            NotificationCreate(
                type="employee_added",
                entity_type="employee",
                entity_id=uuid4(),
                title="Ny ansatt",
                message="Test employee was added",
                severity="info"
            )
        )
        assert notification.id is not None
        assert notification.is_read is False
    
    @pytest.mark.asyncio
    async def test_mark_as_read(db_session):
        # Create notification
        notification = await NotificationService.create(...)
        assert notification.is_read is False
        
        # Mark as read
        updated = await NotificationService.mark_as_read(db_session, notification.id)
        assert updated.is_read is True
    
    @pytest.mark.asyncio
    async def test_get_unread_count(db_session):
        # Create multiple notifications
        for i in range(3):
            await NotificationService.create(...)
        
        count = await NotificationService.get_unread_count(db_session)
        assert count == 3
    
    @pytest.mark.asyncio
    async def test_mark_all_as_read(db_session):
        # Create notifications
        for i in range(3):
            await NotificationService.create(...)
        
        # Mark all as read
        count = await NotificationService.mark_all_as_read(db_session)
        assert count == 3
        
        unread = await NotificationService.get_unread_count(db_session)
        assert unread == 0
    
    @pytest.mark.asyncio
    async def test_clear_all(db_session):
        # Create notifications
        for i in range(3):
            await NotificationService.create(...)
        
        # Clear all
        count = await NotificationService.clear_all(db_session)
        assert count == 3
        
        items, total, _ = await NotificationService.get_all(db_session)
        assert total == 0
    ```
    
    Run tests:
    ```bash
    cd backend
    pytest tests/test_notification_service.py -v
    ```
  </action>
</task>

<task type="auto">
  <name>Task 2: Backend API Tests</name>
  <files>backend/tests/test_notifications_router.py</files>
  <action>
    Create API endpoint tests:
    
    ```python
    import pytest
    from httpx import AsyncClient
    
    @pytest.mark.asyncio
    async def test_list_notifications(client: AsyncClient, auth_headers):
        response = await client.get("/api/notifications", headers=auth_headers)
        assert response.status_code == 200
        data = response.json()
        assert "items" in data
        assert "total" in data
        assert "unread_count" in data
    
    @pytest.mark.asyncio
    async def test_get_unread_count(client: AsyncClient, auth_headers):
        response = await client.get("/api/notifications/unread-count", headers=auth_headers)
        assert response.status_code == 200
        data = response.json()
        assert "count" in data
    
    @pytest.mark.asyncio
    async def test_mark_notification_read(client: AsyncClient, auth_headers, notification_id):
        response = await client.patch(
            f"/api/notifications/{notification_id}/read",
            headers=auth_headers
        )
        assert response.status_code == 200
    
    @pytest.mark.asyncio
    async def test_mark_all_read(client: AsyncClient, auth_headers):
        response = await client.post("/api/notifications/read-all", headers=auth_headers)
        assert response.status_code == 200
    
    @pytest.mark.asyncio
    async def test_clear_all(client: AsyncClient, auth_headers):
        response = await client.post("/api/notifications/clear", headers=auth_headers)
        assert response.status_code == 200
    ```
    
    Run tests:
    ```bash
    cd backend
    pytest tests/test_notifications_router.py -v
    ```
  </action>
</task>

<task type="auto">
  <name>Task 3: Frontend Component Tests</name>
  <files>frontend/src/__tests__/notifications.test.tsx</files>
  <action>
    Create Vitest tests for notification components:
    
    ```typescript
    import { describe, it, expect, vi } from "vitest";
    import { render, screen } from "@testing-library/react";
    import { NotificationItem } from "@/components/notifications/NotificationItem";
    
    const mockNotification = {
      id: "123",
      type: "employee_added" as const,
      entity_type: "employee" as const,
      entity_id: "456",
      title: "Ny ansatt",
      message: "John Doe ble lagt til",
      severity: "info" as const,
      is_read: false,
      metadata: null,
      created_at: new Date().toISOString(),
    };
    
    describe("NotificationItem", () => {
      it("renders notification title and message", () => {
        render(
          <NotificationItem
            notification={mockNotification}
            onMarkAsRead={vi.fn()}
            onDelete={vi.fn()}
          />
        );
        
        expect(screen.getByText("Ny ansatt")).toBeInTheDocument();
        expect(screen.getByText("John Doe ble lagt til")).toBeInTheDocument();
      });
      
      it("shows unread indicator for unread notifications", () => {
        render(
          <NotificationItem
            notification={mockNotification}
            onMarkAsRead={vi.fn()}
            onDelete={vi.fn()}
          />
        );
        
        // Check for unread dot (bronze color)
        const unreadDot = document.querySelector(".bg-\\[\\#BCAB8A\\]");
        expect(unreadDot).toBeInTheDocument();
      });
      
      it("calls onDelete when delete button clicked", async () => {
        const onDelete = vi.fn();
        render(
          <NotificationItem
            notification={mockNotification}
            onMarkAsRead={vi.fn()}
            onDelete={onDelete}
          />
        );
        
        const deleteButton = screen.getByTitle("Fjern varsling");
        await deleteButton.click();
        
        expect(onDelete).toHaveBeenCalledWith("123");
      });
    });
    ```
    
    Run tests:
    ```bash
    cd frontend
    npm run test:run
    ```
  </action>
</task>

<task type="manual">
  <name>Task 4: End-to-End Visual QA</name>
  <files>-</files>
  <action>
    Manual verification checklist:
    
    **Backend API Verification:**
    1. [ ] Start backend: `uvicorn app.main:app --reload`
    2. [ ] GET /api/notifications returns 200 with correct shape
    3. [ ] GET /api/notifications/unread-count returns count
    4. [ ] POST /api/notifications/read-all marks all as read
    5. [ ] POST /api/notifications/clear removes all notifications
    
    **Frontend UI Verification:**
    1. [ ] Start frontend: `npm run dev`
    2. [ ] Bell icon visible in header
    3. [ ] Unread badge shows correct count (or hidden if 0)
    4. [ ] Dropdown opens on click
    5. [ ] Empty state shows when no notifications
    6. [ ] Notifications display with correct icons per type
    7. [ ] Clicking notification navigates to entity
    8. [ ] Unread notifications have bronze dot
    9. [ ] "Mark all read" clears unread count
    10. [ ] "Clear all" removes all notifications
    11. [ ] Delete button removes individual notification
    12. [ ] Timestamps show in Norwegian relative format
    
    **Integration Verification:**
    1. [ ] Trigger employee sync
    2. [ ] New notifications appear in dropdown
    3. [ ] Notification count updates
    4. [ ] Clicking notification navigates to employee
  </action>
</task>

<task type="auto">
  <name>Task 5: Run Full Test Suite</name>
  <files>-</files>
  <action>
    Run complete test suite:
    
    ```bash
    # Backend
    cd backend
    pytest -v
    
    # Frontend
    cd frontend
    npm run test:run
    npm run lint
    npm run build
    ```
    
    All tests should pass. Fix any failures.
  </action>
</task>

<task type="auto">
  <name>Task 6: Update STATE.md</name>
  <files>.planning/STATE.md</files>
  <action>
    Add entry for Phase 08:
    
    ```markdown
    **V3.8 Sync Notification System (Completed YYYY-MM-DD):**
    - ✅ Notification bell dropdown in header
    - ✅ Unread count badge with polling (30s)
    - ✅ Notification types: employee/office added/updated/removed, UPN mismatch, sync error
    - ✅ Click to navigate to related entity
    - ✅ Mark as read, mark all read, clear all actions
    - ✅ Integration with employee and office sync services
    - Plans: `.planning/phases/08-sync-notifications/`
    ```
  </action>
</task>
</tasks>

<success_criteria>
- All backend unit tests pass
- All backend API tests pass
- All frontend component tests pass
- Manual QA checklist completed
- Full test suite passes (pytest + vitest + lint + build)
- STATE.md updated with Phase 08 completion
</success_criteria>
