---
phase: 01-vitec-api-connection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/routers/health.py
  - backend/app/routers/vitec.py
  - backend/app/main.py
  - frontend/src/lib/api/vitec.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin can check if Vitec API credentials are configured"
    - "Admin can test Vitec API connection before attempting sync"
    - "Health endpoint shows actual Vitec API status"
  artifacts:
    - path: "backend/app/routers/vitec.py"
      provides: "Vitec connection test endpoint"
      exports: ["router"]
    - path: "frontend/src/lib/api/vitec.ts"
      provides: "Vitec API client for connection testing"
      exports: ["vitecApi"]
  key_links:
    - from: "backend/app/routers/health.py"
      to: "VitecHubService.is_configured"
      via: "health check service status"
      pattern: "vitec_api.*configured|connected"
    - from: "frontend/src/lib/api/vitec.ts"
      to: "/api/vitec/status"
      via: "fetch call"
      pattern: "apiClient.get.*vitec/status"
---

<objective>
Add Vitec API connection verification endpoints to allow admin to check API status before attempting sync operations.

Purpose: Currently the health endpoint shows "not_configured" for Vitec but doesn't actually test the connection. Admin has no way to verify credentials work before triggering a sync. This plan adds proper connection testing.

Output: Backend endpoint that tests Vitec API connection, updated health check, frontend API client for status checking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-vitec-api-connection/01-RESEARCH.md

# Existing implementation
@backend/app/services/vitec_hub_service.py
@backend/app/routers/health.py
@backend/app/config.py
@frontend/src/lib/api/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vitec status endpoint</name>
  <files>backend/app/routers/vitec.py, backend/app/main.py</files>
  <action>
Create a new router `backend/app/routers/vitec.py` with a status endpoint:

```python
@router.get("/status")
async def get_vitec_status():
    """Check Vitec Hub API configuration and connection status."""
```

The endpoint should:
1. Check if VitecHubService.is_configured returns True
2. If configured, attempt a test call to `Account/Methods` endpoint (already exists as `get_methods()`)
3. Return structured response:
   - `configured: bool` - Are credentials present?
   - `connected: bool` - Did test call succeed?
   - `installation_id: str | null` - The configured installation ID (masked if present)
   - `error: str | null` - Error message if connection failed
   - `available_methods: list[str] | null` - Methods returned by Account/Methods (only if connected)

Use the existing VitecHubService class. Catch HTTPException from the service and convert to error message.

Register the router in main.py with prefix `/api/vitec`.

Do NOT create sync endpoints here - they already exist in offices.py and employees.py.
  </action>
  <verify>
Run: `curl http://localhost:8000/api/vitec/status`
Expected: Returns JSON with configured/connected status (may show configured=false locally if no env vars)
  </verify>
  <done>
/api/vitec/status endpoint returns connection status with clear error messages when credentials missing or API unreachable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update health check to test Vitec</name>
  <files>backend/app/routers/health.py</files>
  <action>
Update the health check endpoint to actually test Vitec API status:

1. Import VitecHubService from `app.services.vitec_hub_service`
2. In the health_check function, replace the hardcoded "not_configured" with actual check:
   - Create VitecHubService instance
   - Check `is_configured` property
   - If configured, set status to "configured"
   - Do NOT make test API calls in health check (too slow) - just check configuration

Update the services dict:
```python
"vitec_api": "configured" if hub.is_configured else "not_configured"
```

This keeps health check fast while providing real configuration status.
  </action>
  <verify>
Run: `curl http://localhost:8000/api/health`
Expected: Returns JSON with services.vitec_api showing "configured" or "not_configured" based on actual env vars.
  </verify>
  <done>
Health check shows real Vitec configuration status instead of hardcoded "not_configured".
  </done>
</task>

<task type="auto">
  <name>Task 3: Create frontend Vitec API client</name>
  <files>frontend/src/lib/api/vitec.ts</files>
  <action>
Create a new API client `frontend/src/lib/api/vitec.ts`:

```typescript
/**
 * Vitec API Client - Connection status and sync triggers
 */

import { apiClient } from './config';

export interface VitecStatus {
  configured: boolean;
  connected: boolean;
  installation_id: string | null;
  error: string | null;
  available_methods: string[] | null;
}

export const vitecApi = {
  async getStatus(): Promise<VitecStatus> {
    const response = await apiClient.get('/vitec/status');
    return response.data;
  },
};
```

Do NOT add sync methods - those already exist in officesApi and employeesApi.

Export from the main api.ts or api/index.ts if a barrel file exists.
  </action>
  <verify>
TypeScript compiles without errors: `cd frontend && npm run build`
  </verify>
  <done>
vitecApi.getStatus() available for frontend to check connection before sync.
  </done>
</task>

</tasks>

<verification>
1. Backend starts without errors: `cd backend && uvicorn app.main:app --reload`
2. Health check shows Vitec status: `curl http://localhost:8000/api/health | jq .services.vitec_api`
3. Vitec status endpoint works: `curl http://localhost:8000/api/vitec/status | jq .`
4. Frontend builds: `cd frontend && npm run build`
</verification>

<success_criteria>
- GET /api/vitec/status returns structured connection status
- GET /api/health shows real vitec_api configuration status
- Frontend has typed API client for Vitec status
- No new TypeScript errors in frontend build
</success_criteria>

<output>
After completion, create `.planning/phases/01-vitec-api-connection/01-01-SUMMARY.md`
</output>
