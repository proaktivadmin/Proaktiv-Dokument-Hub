---
phase: 01-vitec-api-connection
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - frontend/src/app/offices/page.tsx
  - frontend/src/app/employees/page.tsx
  - frontend/src/components/offices/OfficeGrid.tsx
  - frontend/src/components/employees/EmployeeGrid.tsx
  - frontend/src/components/vitec/VitecConnectionStatus.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin sees Vitec connection status before attempting sync"
    - "API errors surface with actual error messages (not generic failures)"
    - "Sync button shows different state based on connection status"
  artifacts:
    - path: "frontend/src/components/vitec/VitecConnectionStatus.tsx"
      provides: "Connection status indicator component"
      exports: ["VitecConnectionStatus"]
  key_links:
    - from: "frontend/src/components/vitec/VitecConnectionStatus.tsx"
      to: "vitecApi.getStatus()"
      via: "useEffect fetch"
      pattern: "vitecApi.getStatus"
    - from: "frontend/src/app/offices/page.tsx"
      to: "error.response?.data?.detail"
      via: "catch block error extraction"
      pattern: "error.*detail|data\\.detail"
---

<objective>
Improve error feedback in the sync UI so admins see actual API error messages instead of generic "Synkronisering feilet" messages.

Purpose: Currently when sync fails, the UI shows a generic error. This makes debugging impossible. Admin needs to see the actual error (e.g., "Vitec Hub unauthorized", "Installation ID not configured") to take corrective action.

Output: Connection status indicator component, improved error handling in sync handlers, clear error messages in toasts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-vitec-api-connection/01-RESEARCH.md
@.planning/phases/01-vitec-api-connection/01-01-SUMMARY.md

# Existing implementation to modify
@frontend/src/app/offices/page.tsx
@frontend/src/app/employees/page.tsx
@frontend/src/components/offices/OfficeGrid.tsx
@frontend/src/lib/api/vitec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VitecConnectionStatus component</name>
  <files>frontend/src/components/vitec/VitecConnectionStatus.tsx</files>
  <action>
Create a new component `frontend/src/components/vitec/VitecConnectionStatus.tsx`:

The component should:
1. Call vitecApi.getStatus() on mount (and optionally on interval)
2. Display one of three states:
   - **Not configured** (yellow warning): Credentials missing in backend
   - **Connected** (green check): API test succeeded
   - **Error** (red X): API test failed, show error message

Use existing Shadcn components:
- Badge or Alert for status display
- Lucide icons: CheckCircle, XCircle, AlertTriangle
- Tooltip to show full error message if truncated

Props:
- `onStatusChange?: (connected: boolean) => void` - Callback when status changes
- `showDetails?: boolean` - Show installation ID and available methods

Keep it compact - this will appear near the sync button.

Example structure:
```tsx
export function VitecConnectionStatus({ onStatusChange, showDetails = false }: Props) {
  const [status, setStatus] = useState<VitecStatus | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    vitecApi.getStatus()
      .then(s => {
        setStatus(s);
        onStatusChange?.(s.connected);
      })
      .catch(() => setStatus({ configured: false, connected: false, error: 'Failed to check', installation_id: null, available_methods: null }))
      .finally(() => setLoading(false));
  }, []);

  // Render based on status...
}
```

Create the directory `frontend/src/components/vitec/` and add an index.ts barrel export.
  </action>
  <verify>
Component file exists and exports VitecConnectionStatus.
TypeScript: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>
VitecConnectionStatus component shows real-time API connection status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Improve sync error handling with detailed messages</name>
  <files>frontend/src/app/offices/page.tsx, frontend/src/app/employees/page.tsx</files>
  <action>
Update the sync error handling in both pages to extract and display actual error messages.

In offices/page.tsx, update the handleSync catch block:
```typescript
} catch (error) {
  console.error("Failed to sync offices:", error);

  // Extract actual error message from backend response
  let errorMessage = "Kunne ikke hente kontorer fra Vitec Hub.";
  if (error instanceof AxiosError && error.response?.data?.detail) {
    errorMessage = error.response.data.detail;
  } else if (error instanceof Error) {
    errorMessage = error.message;
  }

  toast({
    title: "Synkronisering feilet",
    description: errorMessage,
    variant: "destructive",
  });
}
```

Import AxiosError from 'axios' at the top.

Apply the same pattern to employees/page.tsx handleSync function. The employees page syncs both offices AND employees, so the error message should indicate which step failed:

```typescript
try {
  const officeResult = await officesApi.sync();
  const employeeResult = await employeesApi.sync();
  // ... success handling
} catch (error) {
  let errorMessage = "Kunne ikke hente data fra Vitec Hub.";
  if (error instanceof AxiosError && error.response?.data?.detail) {
    errorMessage = error.response.data.detail;
  }
  // ... toast
}
```

Do NOT change the success handling - only improve error messages.
  </action>
  <verify>
Both pages compile without TypeScript errors: `cd frontend && npm run build`
  </verify>
  <done>
Sync errors show actual backend error messages (e.g., "Vitec Hub unauthorized") instead of generic failure text.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add connection status indicator to OfficeGrid</name>
  <files>frontend/src/components/offices/OfficeGrid.tsx</files>
  <action>
Add the VitecConnectionStatus component near the sync button in OfficeGrid.

1. Import VitecConnectionStatus from "@/components/vitec"
2. Add state to track connection status: `const [vitecConnected, setVitecConnected] = useState<boolean | null>(null);`
3. Add the status indicator in the actions area (next to the Sync button)
4. Optionally disable sync button if `vitecConnected === false`

Update the actions section:
```tsx
{showActions && (
  <div className="flex gap-2 ml-auto items-center">
    <VitecConnectionStatus onStatusChange={setVitecConnected} />
    {onSync && (
      <Button
        variant="outline"
        onClick={onSync}
        disabled={isSyncing || vitecConnected === false}
        title={vitecConnected === false ? "Vitec API ikke tilkoblet" : undefined}
      >
        <RefreshCcw className="h-4 w-4 mr-2" />
        {isSyncing ? "Synkroniserer..." : "Synkroniser Vitec"}
      </Button>
    )}
    {/* ... create button */}
  </div>
)}
```

The button should still be clickable when `vitecConnected === null` (loading state) to avoid blocking the user before the status check completes.
  </action>
  <verify>
Run frontend dev server: `cd frontend && npm run dev`
Navigate to /offices and verify the connection status appears.
  </verify>
  <done>
OfficeGrid shows Vitec connection status and conditionally disables sync button when not connected.
  </done>
</task>

</tasks>

<verification>
1. Frontend builds: `cd frontend && npm run build`
2. Visit /offices - connection status indicator visible near sync button
3. If Vitec not configured (locally), status shows "Not configured"
4. Sync button disabled when connection status is "Error"
5. Failed sync attempt shows actual error message in toast (e.g., "Vitec Hub credentials are not configured")
</verification>

<success_criteria>
- VitecConnectionStatus component exists and displays real connection status
- Sync errors show actual backend error messages instead of generic failures
- Connection status visible on offices page before attempting sync
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-vitec-api-connection/01-02-SUMMARY.md`
</output>
