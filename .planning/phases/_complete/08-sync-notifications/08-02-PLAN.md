---
phase: 08-sync-notifications
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - backend/app/schemas/notification.py
  - backend/app/services/notification_service.py
  - backend/app/routers/notifications.py
  - backend/app/main.py
autonomous: true
---

<objective>
Create the NotificationService with CRUD operations and REST API endpoints for managing notifications.
</objective>

<context>
Read these files first:
- `.planning/phases/08-sync-notifications/HANDOVER.md` - Master context and API endpoints
- `backend/app/models/notification.py` - Notification model (created in 08-01)
- `backend/app/services/employee_service.py` - Service pattern to follow
- `backend/app/routers/employees.py` - Router pattern to follow
- `backend/app/schemas/employee.py` - Schema pattern to follow
</context>

<tasks>
<task type="auto">
  <name>Task 1: Create Notification Schemas</name>
  <files>backend/app/schemas/notification.py</files>
  <action>
    Create Pydantic schemas:
    
    ```python
    from pydantic import BaseModel, Field
    from datetime import datetime
    from uuid import UUID
    from typing import Literal
    
    NotificationType = Literal[
        "employee_added", "employee_removed", "employee_updated",
        "office_added", "office_removed", "office_updated",
        "upn_mismatch", "sync_error"
    ]
    
    NotificationSeverity = Literal["info", "warning", "error"]
    NotificationEntityType = Literal["employee", "office", "sync"]
    
    class NotificationBase(BaseModel):
        type: NotificationType
        entity_type: NotificationEntityType
        entity_id: UUID | None = None
        title: str = Field(max_length=255)
        message: str
        severity: NotificationSeverity = "info"
        metadata: dict | None = None
    
    class NotificationCreate(NotificationBase):
        pass
    
    class NotificationResponse(NotificationBase):
        id: UUID
        is_read: bool
        created_at: datetime
        
        class Config:
            from_attributes = True
    
    class NotificationListResponse(BaseModel):
        items: list[NotificationResponse]
        total: int
        unread_count: int
    
    class UnreadCountResponse(BaseModel):
        count: int
    ```
  </action>
</task>

<task type="auto">
  <name>Task 2: Create NotificationService</name>
  <files>backend/app/services/notification_service.py</files>
  <action>
    Create async service with methods:
    
    ```python
    class NotificationService:
        @staticmethod
        async def create(db: AsyncSession, data: NotificationCreate) -> Notification
        
        @staticmethod
        async def get_all(
            db: AsyncSession,
            skip: int = 0,
            limit: int = 20,
            unread_only: bool = False
        ) -> tuple[list[Notification], int, int]  # items, total, unread_count
        
        @staticmethod
        async def get_unread_count(db: AsyncSession) -> int
        
        @staticmethod
        async def mark_as_read(db: AsyncSession, notification_id: UUID) -> Notification | None
        
        @staticmethod
        async def mark_all_as_read(db: AsyncSession) -> int  # returns count
        
        @staticmethod
        async def delete(db: AsyncSession, notification_id: UUID) -> bool
        
        @staticmethod
        async def clear_all(db: AsyncSession) -> int  # returns count
    ```
    
    Helper methods for sync integration:
    
    ```python
        @staticmethod
        async def notify_employee_added(db: AsyncSession, employee: Employee) -> Notification
        
        @staticmethod
        async def notify_employee_updated(db: AsyncSession, employee: Employee, changed_fields: list[str]) -> Notification
        
        @staticmethod
        async def notify_employee_removed(db: AsyncSession, employee: Employee) -> Notification
        
        @staticmethod
        async def notify_office_added(db: AsyncSession, office: Office) -> Notification
        
        @staticmethod
        async def notify_office_updated(db: AsyncSession, office: Office, changed_fields: list[str]) -> Notification
        
        @staticmethod
        async def notify_office_removed(db: AsyncSession, office: Office) -> Notification
        
        @staticmethod
        async def notify_upn_mismatch(db: AsyncSession, employee: Employee, expected_upn: str, actual_upn: str) -> Notification
        
        @staticmethod
        async def notify_sync_error(db: AsyncSession, operation: str, error: str) -> Notification
    ```
  </action>
</task>

<task type="auto">
  <name>Task 3: Create Notifications Router</name>
  <files>backend/app/routers/notifications.py</files>
  <action>
    Create FastAPI router with endpoints:
    
    ```python
    router = APIRouter(prefix="/notifications", tags=["notifications"])
    
    @router.get("", response_model=NotificationListResponse)
    async def list_notifications(
        skip: int = 0,
        limit: int = 20,
        unread_only: bool = False,
        db: AsyncSession = Depends(get_db)
    )
    
    @router.get("/unread-count", response_model=UnreadCountResponse)
    async def get_unread_count(db: AsyncSession = Depends(get_db))
    
    @router.patch("/{notification_id}/read", response_model=NotificationResponse)
    async def mark_notification_read(
        notification_id: UUID,
        db: AsyncSession = Depends(get_db)
    )
    
    @router.post("/read-all")
    async def mark_all_read(db: AsyncSession = Depends(get_db))
    
    @router.delete("/{notification_id}")
    async def delete_notification(
        notification_id: UUID,
        db: AsyncSession = Depends(get_db)
    )
    
    @router.post("/clear")
    async def clear_all_notifications(db: AsyncSession = Depends(get_db))
    ```
  </action>
</task>

<task type="auto">
  <name>Task 4: Register Router in main.py</name>
  <files>backend/app/main.py</files>
  <action>
    Add router import and registration:
    
    ```python
    from app.routers import notifications
    
    # In the router registration section:
    app.include_router(notifications.router, prefix="/api")
    ```
  </action>
</task>

<task type="auto">
  <name>Task 5: Test API Endpoints</name>
  <files>-</files>
  <action>
    Start the backend server and test endpoints:
    
    ```bash
    # Start server
    cd backend
    uvicorn app.main:app --reload
    
    # Test endpoints with curl or httpie:
    # GET /api/notifications
    # GET /api/notifications/unread-count
    # POST /api/notifications/read-all
    # POST /api/notifications/clear
    ```
    
    Create a test notification manually to verify:
    ```python
    # In Python shell or test script
    from app.services.notification_service import NotificationService
    from app.schemas.notification import NotificationCreate
    
    notification = await NotificationService.create(db, NotificationCreate(
        type="employee_added",
        entity_type="employee",
        title="Ny ansatt",
        message="Test notification",
        severity="info"
    ))
    ```
  </action>
</task>
</tasks>

<success_criteria>
- NotificationService created with all CRUD methods
- Helper methods for each notification type implemented
- REST endpoints respond correctly:
  - GET /api/notifications returns list with pagination
  - GET /api/notifications/unread-count returns count
  - PATCH /api/notifications/{id}/read marks as read
  - POST /api/notifications/read-all marks all read
  - DELETE /api/notifications/{id} deletes notification
  - POST /api/notifications/clear deletes all
- Router registered in main.py
- No import errors or type errors
</success_criteria>
