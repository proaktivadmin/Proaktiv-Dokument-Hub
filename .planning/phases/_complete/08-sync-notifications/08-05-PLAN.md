---
phase: 08-sync-notifications
plan: 05
type: execute
wave: 5
depends_on: [08-02]
files_modified:
  - backend/app/services/employee_service.py
  - backend/app/services/office_service.py
autonomous: true
---

<objective>
Integrate NotificationService into employee and office sync operations to generate notifications on data changes.
</objective>

<context>
Read these files first:
- `.planning/phases/08-sync-notifications/HANDOVER.md` - Master context and notification types
- `backend/app/services/notification_service.py` - NotificationService (created in 08-02)
- `backend/app/services/employee_service.py` - Employee sync methods to modify
- `backend/app/services/office_service.py` - Office sync methods to modify
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add Notification Import to Employee Service</name>
  <files>backend/app/services/employee_service.py</files>
  <action>
    Add import at top of file:
    
    ```python
    from app.services.notification_service import NotificationService
    ```
  </action>
</task>

<task type="auto">
  <name>Task 2: Integrate Notifications in Employee upsert_from_hub</name>
  <files>backend/app/services/employee_service.py</files>
  <action>
    In the `upsert_from_hub` method, after creating or updating an employee:
    
    For new employees (created):
    ```python
    # After creating employee
    await NotificationService.notify_employee_added(db, employee)
    ```
    
    For updated employees:
    ```python
    # When fields are changed, track which fields changed
    changed_fields = []
    if existing.title != employee_data.get("title"):
        changed_fields.append("title")
    # ... check other fields
    
    if changed_fields:
        await NotificationService.notify_employee_updated(db, employee, changed_fields)
    ```
    
    Be careful to:
    - Only notify on actual data changes, not every sync
    - Track which fields changed for the notification message
    - Handle errors gracefully (notification failure shouldn't break sync)
  </action>
</task>

<task type="auto">
  <name>Task 3: Integrate Notifications in Employee sync_from_hub</name>
  <files>backend/app/services/employee_service.py</files>
  <action>
    In the `sync_from_hub` method:
    
    1. After successful sync, if there were errors:
    ```python
    if sync_errors:
        await NotificationService.notify_sync_error(
            db,
            operation="employee_sync",
            error=f"{len(sync_errors)} employees failed to sync"
        )
    ```
    
    2. Wrap notification calls in try/except to prevent sync failures:
    ```python
    try:
        await NotificationService.notify_employee_added(db, employee)
    except Exception as e:
        logger.warning(f"Failed to create notification: {e}")
    ```
  </action>
</task>

<task type="auto">
  <name>Task 4: Add Notification Import to Office Service</name>
  <files>backend/app/services/office_service.py</files>
  <action>
    Add import at top of file:
    
    ```python
    from app.services.notification_service import NotificationService
    ```
  </action>
</task>

<task type="auto">
  <name>Task 5: Integrate Notifications in Office upsert_from_hub</name>
  <files>backend/app/services/office_service.py</files>
  <action>
    In the `upsert_from_hub` method, after creating or updating an office:
    
    For new offices (created):
    ```python
    await NotificationService.notify_office_added(db, office)
    ```
    
    For updated offices:
    ```python
    changed_fields = []
    if existing.name != office_data.get("name"):
        changed_fields.append("name")
    # ... check other fields
    
    if changed_fields:
        await NotificationService.notify_office_updated(db, office, changed_fields)
    ```
  </action>
</task>

<task type="auto">
  <name>Task 6: Integrate Notifications in Office sync_from_hub</name>
  <files>backend/app/services/office_service.py</files>
  <action>
    In the `sync_from_hub` method:
    
    ```python
    if sync_errors:
        await NotificationService.notify_sync_error(
            db,
            operation="office_sync",
            error=f"{len(sync_errors)} offices failed to sync"
        )
    ```
  </action>
</task>

<task type="auto">
  <name>Task 7: Add UPN Mismatch Notification (Optional)</name>
  <files>backend/app/services/employee_service.py</files>
  <action>
    If there's existing UPN mismatch detection logic (check for entra_upn_mismatch field usage):
    
    ```python
    if employee.entra_upn_mismatch:
        await NotificationService.notify_upn_mismatch(
            db,
            employee,
            expected_upn=employee.email,
            actual_upn=employee.entra_upn or "unknown"
        )
    ```
    
    This may already be handled in the Entra sync script. Only add if relevant.
  </action>
</task>

<task type="auto">
  <name>Task 8: Test Integration</name>
  <files>-</files>
  <action>
    Test the integration by:
    
    1. Start the backend server:
    ```bash
    cd backend
    uvicorn app.main:app --reload
    ```
    
    2. Trigger a sync operation (if available via API):
    ```bash
    curl -X POST http://localhost:8000/api/employees/sync
    ```
    
    3. Check notifications were created:
    ```bash
    curl http://localhost:8000/api/notifications
    ```
    
    Alternatively, create a test script:
    ```python
    # backend/scripts/test_notification_integration.py
    import asyncio
    from app.database import get_db_session
    from app.services.employee_service import EmployeeService
    from app.services.notification_service import NotificationService
    
    async def test():
        async with get_db_session() as db:
            # Get current notification count
            items, total, unread = await NotificationService.get_all(db)
            print(f"Before: {total} notifications")
            
            # Trigger sync (or create test notification)
            await NotificationService.notify_sync_error(db, "test", "Test notification")
            
            items, total, unread = await NotificationService.get_all(db)
            print(f"After: {total} notifications")
    
    asyncio.run(test())
    ```
  </action>
</task>
</tasks>

<success_criteria>
- NotificationService imported in both employee_service.py and office_service.py
- New employees trigger employee_added notification
- Updated employees trigger employee_updated notification (with changed fields)
- New offices trigger office_added notification
- Updated offices trigger office_updated notification
- Sync errors trigger sync_error notification
- Notification failures don't break sync operations (wrapped in try/except)
- Test sync creates notifications visible in /api/notifications
</success_criteria>
