---
phase: 08-sync-notifications
plan: 04
type: execute
wave: 4
depends_on: [08-03]
files_modified:
  - frontend/src/components/notifications/NotificationDropdown.tsx
  - frontend/src/components/notifications/NotificationItem.tsx
  - frontend/src/components/layout/Header.tsx
autonomous: true
---

<objective>
Create the notification dropdown UI components and integrate them into the Header.
</objective>

<context>
Read these files first:
- `.planning/phases/08-sync-notifications/HANDOVER.md` - Master context and UI specs
- `.planning/codebase/DESIGN-SYSTEM.md` - Design tokens and patterns
- `frontend/src/components/layout/Header.tsx` - Where to add notification bell
- `frontend/src/components/ui/dropdown-menu.tsx` - Dropdown components to use
- `frontend/src/hooks/use-notifications.ts` - Hook created in 08-03
</context>

<tasks>
<task type="auto">
  <name>Task 1: Create NotificationItem Component</name>
  <files>frontend/src/components/notifications/NotificationItem.tsx</files>
  <action>
    Create component for individual notification rows:
    
    ```tsx
    "use client";
    
    import { useRouter } from "next/navigation";
    import { formatDistanceToNow } from "date-fns";
    import { nb } from "date-fns/locale";
    import {
      UserPlus, UserMinus, UserCog, Building2, Building, AlertTriangle,
      XCircle, Info, AlertCircle, X
    } from "lucide-react";
    import { cn } from "@/lib/utils";
    import type { Notification } from "@/types/notification";
    
    interface NotificationItemProps {
      notification: Notification;
      onMarkAsRead: (id: string) => void;
      onDelete: (id: string) => void;
    }
    
    // Map notification type to icon
    const typeIcons = {
      employee_added: UserPlus,
      employee_removed: UserMinus,
      employee_updated: UserCog,
      office_added: Building2,
      office_removed: Building,
      office_updated: Building2,
      upn_mismatch: AlertTriangle,
      sync_error: XCircle,
    };
    
    // Map severity to colors (using design system colors)
    const severityStyles = {
      info: "text-emerald-600 bg-emerald-50",
      warning: "text-amber-600 bg-amber-50",
      error: "text-red-600 bg-red-50",
    };
    
    export function NotificationItem({
      notification,
      onMarkAsRead,
      onDelete,
    }: NotificationItemProps) {
      const router = useRouter();
      const Icon = typeIcons[notification.type];
      
      const handleClick = () => {
        if (!notification.is_read) {
          onMarkAsRead(notification.id);
        }
        
        // Navigate to related entity if exists
        if (notification.entity_id) {
          if (notification.entity_type === "employee") {
            router.push(`/employees/${notification.entity_id}`);
          } else if (notification.entity_type === "office") {
            router.push(`/offices/${notification.entity_id}`);
          }
        }
      };
      
      const handleDelete = (e: React.MouseEvent) => {
        e.stopPropagation();
        onDelete(notification.id);
      };
      
      return (
        <div
          onClick={handleClick}
          className={cn(
            "flex items-start gap-3 px-4 py-3 cursor-pointer transition-colors duration-fast",
            "hover:bg-[#E9E7DC]/50",
            !notification.is_read && "bg-[#E9E7DC]/30"
          )}
        >
          {/* Icon with severity color */}
          <div className={cn(
            "shrink-0 p-1.5 rounded-full",
            severityStyles[notification.severity]
          )}>
            <Icon className="h-4 w-4" />
          </div>
          
          {/* Content */}
          <div className="flex-1 min-w-0">
            <div className="flex items-start justify-between gap-2">
              <p className={cn(
                "text-sm text-[#272630]",
                !notification.is_read && "font-medium"
              )}>
                {notification.title}
              </p>
              
              {/* Unread indicator */}
              {!notification.is_read && (
                <div className="shrink-0 h-2 w-2 rounded-full bg-[#BCAB8A]" />
              )}
            </div>
            
            <p className="text-xs text-[#272630]/60 mt-0.5 line-clamp-2">
              {notification.message}
            </p>
            
            <p className="text-xs text-[#272630]/40 mt-1">
              {formatDistanceToNow(new Date(notification.created_at), {
                addSuffix: true,
                locale: nb,
              })}
            </p>
          </div>
          
          {/* Delete button */}
          <button
            onClick={handleDelete}
            className="shrink-0 p-1 rounded-md text-[#272630]/40 hover:text-[#272630] hover:bg-[#272630]/10 transition-colors duration-fast"
            title="Fjern varsling"
          >
            <X className="h-3.5 w-3.5" />
          </button>
        </div>
      );
    }
    ```
  </action>
</task>

<task type="auto">
  <name>Task 2: Create NotificationDropdown Component</name>
  <files>frontend/src/components/notifications/NotificationDropdown.tsx</files>
  <action>
    Create the main dropdown component:
    
    ```tsx
    "use client";
    
    import { Bell, Check, Trash2, RefreshCw } from "lucide-react";
    import {
      DropdownMenu,
      DropdownMenuContent,
      DropdownMenuTrigger,
      DropdownMenuSeparator,
    } from "@/components/ui/dropdown-menu";
    import { Button } from "@/components/ui/button";
    import { useNotifications } from "@/hooks/use-notifications";
    import { NotificationItem } from "./NotificationItem";
    import { cn } from "@/lib/utils";
    
    export function NotificationDropdown() {
      const {
        notifications,
        unreadCount,
        isLoading,
        refresh,
        markAsRead,
        markAllAsRead,
        deleteNotification,
        clearAll,
      } = useNotifications({ limit: 20, pollInterval: 30000 });
      
      return (
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <button
              className={cn(
                "relative p-2 rounded-md transition-colors duration-fast",
                "text-[#272630]/70 hover:text-[#272630] hover:bg-white/40"
              )}
              title="Varsler"
            >
              <Bell className="h-5 w-5" />
              
              {/* Unread badge */}
              {unreadCount > 0 && (
                <span className={cn(
                  "absolute -top-0.5 -right-0.5 flex items-center justify-center",
                  "min-w-[18px] h-[18px] px-1 rounded-full",
                  "bg-red-500 text-white text-[10px] font-medium",
                  "animate-in fade-in zoom-in duration-fast"
                )}>
                  {unreadCount > 99 ? "99+" : unreadCount}
                </span>
              )}
            </button>
          </DropdownMenuTrigger>
          
          <DropdownMenuContent
            align="end"
            className="w-80 max-h-[480px] p-0 bg-white shadow-elevated overflow-hidden"
          >
            {/* Header */}
            <div className="flex items-center justify-between px-4 py-3 border-b border-[#E5E5E5]">
              <h3 className="font-serif font-semibold text-[#272630]">Varsler</h3>
              <div className="flex items-center gap-1">
                <button
                  onClick={() => refresh()}
                  className="p-1.5 rounded-md text-[#272630]/60 hover:text-[#272630] hover:bg-[#E9E7DC] transition-colors duration-fast"
                  title="Oppdater"
                >
                  <RefreshCw className={cn("h-4 w-4", isLoading && "animate-spin")} />
                </button>
                {unreadCount > 0 && (
                  <button
                    onClick={() => markAllAsRead()}
                    className="p-1.5 rounded-md text-[#272630]/60 hover:text-[#272630] hover:bg-[#E9E7DC] transition-colors duration-fast"
                    title="Merk alle som lest"
                  >
                    <Check className="h-4 w-4" />
                  </button>
                )}
                {notifications.length > 0 && (
                  <button
                    onClick={() => clearAll()}
                    className="p-1.5 rounded-md text-[#272630]/60 hover:text-red-600 hover:bg-red-50 transition-colors duration-fast"
                    title="Fjern alle"
                  >
                    <Trash2 className="h-4 w-4" />
                  </button>
                )}
              </div>
            </div>
            
            {/* Notification list */}
            <div className="max-h-[400px] overflow-y-auto">
              {isLoading && notifications.length === 0 ? (
                <div className="flex items-center justify-center py-8 text-[#272630]/40">
                  <RefreshCw className="h-5 w-5 animate-spin" />
                </div>
              ) : notifications.length === 0 ? (
                <div className="flex flex-col items-center justify-center py-8 text-[#272630]/40">
                  <Bell className="h-8 w-8 mb-2" />
                  <p className="text-sm">Ingen varsler</p>
                </div>
              ) : (
                <div className="divide-y divide-[#E5E5E5]/50">
                  {notifications.map((notification) => (
                    <NotificationItem
                      key={notification.id}
                      notification={notification}
                      onMarkAsRead={markAsRead}
                      onDelete={deleteNotification}
                    />
                  ))}
                </div>
              )}
            </div>
          </DropdownMenuContent>
        </DropdownMenu>
      );
    }
    ```
  </action>
</task>

<task type="auto">
  <name>Task 3: Integrate into Header</name>
  <files>frontend/src/components/layout/Header.tsx</files>
  <action>
    Add NotificationDropdown to Header between "Ny mal" button and logout button:
    
    1. Add import:
    ```tsx
    import { NotificationDropdown } from "@/components/notifications/NotificationDropdown";
    ```
    
    2. Add component in nav, after the "Ny mal" dropdown and before logout button:
    ```tsx
    {/* Notification Dropdown */}
    <NotificationDropdown />
    
    <Button
      variant="ghost"
      size="icon"
      onClick={handleLogout}
      ...
    ```
  </action>
</task>

<task type="auto">
  <name>Task 4: Create Index Export</name>
  <files>frontend/src/components/notifications/index.ts</files>
  <action>
    Create barrel export:
    
    ```typescript
    export { NotificationDropdown } from "./NotificationDropdown";
    export { NotificationItem } from "./NotificationItem";
    ```
  </action>
</task>

<task type="auto">
  <name>Task 5: Verify Frontend Build</name>
  <files>-</files>
  <action>
    Run build to verify no errors:
    
    ```bash
    cd frontend
    npm run build
    ```
    
    Also run lint:
    ```bash
    npm run lint
    ```
    
    Fix any errors that appear.
  </action>
</task>
</tasks>

<success_criteria>
- NotificationItem displays:
  - Icon based on notification type
  - Title with unread indicator (bronze dot)
  - Message preview (2 lines max)
  - Relative timestamp in Norwegian
  - Delete button
  - Click navigates to entity
- NotificationDropdown displays:
  - Bell icon with unread count badge
  - Header with "Varsler" title
  - Action buttons (refresh, mark all read, clear all)
  - Scrollable notification list
  - Empty state when no notifications
  - Loading state
- Header shows notification bell between "Ny mal" and logout
- Design tokens used (colors, shadows, transitions)
- Build passes without errors
</success_criteria>
