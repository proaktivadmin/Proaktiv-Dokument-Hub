# Migration Specification: Azure → Vercel + Railway

**Created:** 2026-01-16
**Agent:** Migration Architect
**Status:** Complete

---

## Executive Summary

This document specifies the technical changes required to migrate from Azure Container Apps to Vercel (frontend) + Railway (backend + PostgreSQL). The good news: **most of the hard work is already done**. The codebase already supports storing template content in the database.

---

## Current State Analysis

### What's Already Done (V2.7 Fixes)
1. ✅ Template model has `content` column (TEXT)
2. ✅ `TemplateContentService` exists for saving content to database
3. ✅ Cross-database type adapters (GUID, JSONType) work with both PostgreSQL and SQLite
4. ✅ Frontend uses dynamic API URL detection

### What Still References Azure

| File | Azure Dependency | Action |
|------|------------------|--------|
| `backend/app/config.py` | AZURE_STORAGE_* variables | Comment out |
| `backend/app/services/azure_storage_service.py` | Full Azure Blob SDK | Deprecate |
| `backend/app/models/template.py` | `azure_blob_url` column | Keep (historical) |
| `frontend/next.config.js` | `*.blob.core.windows.net` in images | Remove |
| `frontend/src/lib/api/config.ts` | Azure hostname detection | Simplify |
| `infrastructure/bicep/main.bicep` | Full Azure infrastructure | Delete |
| `.github/workflows/deploy-azure.yml` | Azure deployment workflow | Delete |
| `backend/scripts/check_azure_urls.py` | Azure URL checker | Delete |
| `backend/scripts/upload_company_portal_files.py` | Azure upload script | Delete |

---

## Database Schema

### Current State (Already Correct)
The Template model already has what we need:

```python
# backend/app/models/template.py
class Template(Base):
    # ... other fields ...
    content: Mapped[Optional[str]] = mapped_column(Text, nullable=True)  # ✅ EXISTS
    azure_blob_url: Mapped[str] = mapped_column(Text, nullable=False)    # Keep for reference
```

### Migration Strategy
- **No schema changes needed** - content column already exists
- Templates with `content = NULL` will need to be imported from files
- `azure_blob_url` kept for historical reference (don't delete)

---

## Backend Changes

### 1. Config Simplification
**File:** `backend/app/config.py`

```python
# Comment out Azure variables (don't delete for rollback)
# AZURE_STORAGE_CONNECTION_STRING: str = ""
# AZURE_STORAGE_CONTAINER_NAME: str = "templates"
# AZURE_CONTAINER_NAME: str = "templates"
# AZURE_STORAGE_PREVIEWS_CONTAINER: str = "previews"
# KEY_VAULT_URL: str = ""

# Add Railway/Vercel indicator
PLATFORM: str = "railway"  # or "azure" for rollback
```

### 2. Template Import Endpoint
**File:** `backend/app/routers/admin.py` (create new)

```python
@router.post("/import-templates")
async def import_templates_from_files(
    db: AsyncSession = Depends(get_db)
) -> dict:
    """
    One-time import of templates from library/ folder.
    Reads HTML files and stores content in database.
    """
    # Implementation details in handoff
```

### 3. Azure Storage Service
**File:** `backend/app/services/azure_storage_service.py`

**Action:** Keep file but add deprecation warning:
```python
import warnings

class AzureStorageService:
    def __init__(self):
        warnings.warn(
            "AzureStorageService is deprecated. "
            "Template content is now stored in database.",
            DeprecationWarning
        )
        # ... rest of code
```

---

## Frontend Changes

### 1. Next.js Config
**File:** `frontend/next.config.js`

Remove Azure Blob image patterns:
```javascript
// BEFORE
images: {
  remotePatterns: [
    {
      protocol: 'https',
      hostname: '*.blob.core.windows.net',  // REMOVE THIS
    },
  ],
},

// AFTER
// Remove entire images block - not needed for database content
```

### 2. API Config
**File:** `frontend/src/lib/api/config.ts`

Simplify to remove Azure-specific detection:
```typescript
export function getApiBaseUrl(): string {
  // Railway/Vercel: just use relative URLs (Next.js rewrites)
  // or NEXT_PUBLIC_API_URL if set
  return process.env.NEXT_PUBLIC_API_URL || "";
}
```

---

## Files to Delete

| Path | Reason |
|------|--------|
| `infrastructure/bicep/` | Azure infrastructure - not needed |
| `infrastructure/scripts/deploy.sh` | Azure deployment script |
| `.github/workflows/deploy-azure.yml` | Azure CI/CD workflow |
| `backend/scripts/check_azure_urls.py` | Azure-specific script |
| `backend/scripts/upload_company_portal_files.py` | Azure-specific script |

---

## Environment Variables

### Railway (Backend)
| Variable | Value | Required |
|----------|-------|----------|
| `DATABASE_URL` | Auto-generated by Railway PostgreSQL | Yes |
| `APP_ENV` | `production` | Yes |
| `SECRET_KEY` | 32+ character random string | Yes |
| `ALLOWED_ORIGINS` | `["https://YOUR-APP.vercel.app"]` | Yes |
| `LOG_LEVEL` | `INFO` | No |

### Vercel (Frontend)
| Variable | Value | Required |
|----------|-------|----------|
| `BACKEND_URL` | Railway backend URL | Yes |

---

## Template Import Strategy

### One-Time Import Process
1. Templates exist in `library/` folder as HTML files
2. Backend reads each file and populates `content` column
3. `azure_blob_url` set to placeholder or kept as historical reference

### Import Endpoint Logic
```python
async def import_from_library(db: AsyncSession, library_path: str) -> int:
    """
    For each template in database where content is NULL:
    1. Find matching HTML file in library_path
    2. Read file content
    3. Save to template.content
    """
    count = 0
    templates = await db.execute(
        select(Template).where(Template.content.is_(None))
    )
    for template in templates.scalars():
        # Match by file_name
        file_path = Path(library_path) / template.file_name
        if file_path.exists():
            template.content = file_path.read_text(encoding='utf-8')
            count += 1
    await db.commit()
    return count
```

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Import misses some templates | Low | Medium | Verify count matches (43) |
| Database size with content | Low | Low | HTML is small (~100KB total) |
| Rollback needed | Low | Low | Azure branch still works |
| CORS issues | Medium | Low | Test before going live |

---

## Verification Checklist

After migration:
- [ ] Backend health check passes
- [ ] 43 templates in database with content
- [ ] Dashboard loads
- [ ] Template preview renders
- [ ] Code editor loads content
- [ ] Save functionality works
- [ ] No Azure references in network tab
- [ ] No console errors

---

## Timeline Estimate

| Task | Duration |
|------|----------|
| Backend changes | 1-2 hours |
| Frontend changes | 30 min |
| Railway setup | 30 min |
| Vercel setup | 15 min |
| Template import | 15 min |
| Testing | 30 min |
| **Total** | ~3-4 hours |
